#!/usr/bin/env bash
# Returns the current track through Spotify or mpd

function music-status {
  if [[ $(mpc) =~ "play" ]]; then
    mpd-status
  else
    case "$OSTYPE" in
      (darwin*)
        apple-spotify-status
        ;;
      (linux*)
        # linux-spotify-status
        ;;
      (*)
        printf ""
        ;;
    esac
  fi
}

function mpd-status {
  local artist
  local song
  artist=$(
    ncmpcpp --current-song "%a" --quiet |
    awk -F 'f[ea]*t' '{ print $1 }'
  )
  song=$(
    ncmpcpp --current-song "%t" --quiet |
    awk -F '.Explicit' '{ print $1 }'
  )
  artist=$(shorten-string "$artist")
  song=$(shorten-string "$song")
  printf "â™« %s - %s" "$artist" "$song"
}

function shorten-string {
  local length
  local string
  length=15
  printf "$1" |
    awk -v len=$length '{
      if (length($0) > len)
        print substr($0, 1, len-3) "..."
      else
        print;
      }'
}

music-status "$@"
